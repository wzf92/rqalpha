# rqalpha框架
## 概述
基于米筐的开源框架rqalpha进行二次开发。仓库地址：[New rqalpha](https://github.com/wzf92/rqalpha.git) ，分支：dev

rqalpha已有的公开文档以及原生代码链接整理如下：

- [rqalpha开源代码仓库](https://github.com/ricequant/rqalpha)  
- [使用文档](https://www.ricequant.com/doc/rqalpha-plus/tutorial.html)  
- [API手册](https://www.ricequant.com/doc/rqalpha-plus/api/)  
- [开发手册](https://rqalpha.readthedocs.io/zh_CN/latest/)  

注意：米筐开源的代码内容，并不等同于米筐自己使用的在线回测平台程序，开源代码有一些功能不完善。例如开源代码只支持了按天粒度的回测，并且也只提供按天粒度的bar数据。而米筐官网的回测平台则没有这些局限。因此我们需要在[rqalpha开源代码仓库](https://github.com/ricequant/rqalpha)的基础上再做一些功能完善。
## 核心设计理念-事件驱动
rqalpha框架的核心设计理念是使用事件驱动机制。所谓的事件驱动，简单来说是把程序的执行过程分成两大部分：事件生成和事件处理(类似于生产者和消费者的关系)。在程序开始时，会根据配置和加载的模块，先准备事件生成器(EventSource)以及事件处理模块(包括策略模块、日志模块、账户信息模块等)。 
## 主流程框图 
框架的主体运行流程表示如下：  
![事件驱动](http://121.40.85.7/rqalpha_framework.png)

1. 从配置读取事件生成器需要的配置，对于回测而言，就是3个参数：回测开始时间、回测结束时间、回测时间粒度。例如回测开始时间是2020.1.1，结束时间是2020.6.1，粒度是分钟。那么之后时间生成器将会根据这个时间区间，生成事件。这些事件后续会分发给其他各个模块进行实际处理。进入步骤2。
2. 事件生成器初始化当前时间为起始时间2020.1.1。进入步骤3。
3. 若当前时间是在结束时间2020.6.1之前，进入步骤4；否则进入步骤6。
4. 发布2020.1.1的事件，顺序依次为：盘前事件(BEFORE_TRADING，只有1个)，盘中事件(BAR，每分钟1个)，盘后事件(AFTER_TRADING，1个)。其中，策略模块会去处理BAR事件，一个BAR事件的处理过程其实就是对应于一个一分钟kline bar的算法执行。进入步骤5。
5. 更新当前时间为下一个交易日，进入步骤3。
6. 事件生成器发布程序的最后一个事件：结算事件(SETTLEMENT)。此时，日志模块、算法分析模块等会介入处理，比如计算收益率、夏普率、最大回撤、输出回测交易日志、回测账户资金变化等。