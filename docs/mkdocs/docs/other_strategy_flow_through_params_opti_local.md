# 流量突破策略-局部最优参数遍历
## 问题背景
流量阈值突破策略，想做全品种参数遍历，寻找回测效果较优的参数。但因涉及的参数较多，包括了`阈值突破类型、开仓阈值、平仓阈值、止盈、止损`这些维度，粗略估算全局遍历单一品种需要的参数组得有：  

- 阈值突破类型: 4种
- 开仓阈值: 9种 (0.1到0.9，步长0.1)
- 平仓阈值: 9种 (0.1到0.9，步长0.1)
- 止盈: 9种 (0.01到0.05，步长0.005)
- 止损: 9种 (0.01到0.05，步长0.005)

组合起来: 4\*9\*9\*9\*9 = 26244  
每组参数回测时间需要1-5分钟。可见全局遍历耗时太长。因此考虑寻找局部最优。

## 评价指标
- 年化收益率
- 最大回撤
- 夏普率
- 交易频率
- 参数局部稳定
@TODO 如何量化?

## 遍历方案
### 1. 先固定止盈止损，选取4\*9组典型的阈值参数
先固定止盈止损，都取中值0.03。然后每种阈值突破类型选取9组参数，共选36组。具体选择如下:
#### 1.1 一类型(9组)
BK:>正 SP:<正, SK:<负, BP:>负
##### 1.1.1 开仓阈值 = 平仓阈值 (3组)
- BK:>0.2, SP:<0.2, SK:<-0.2, BP:>-0.2
- BK:>0.5, SP:<0.5, SK:<-0.5, BP:>-0.5
- BK:>0.8, SP:<0.8, SK:<-0.8, BP:>-0.8
##### 1.1.2 开仓阈值 > 平仓阈值 (3组)
- BK:>0.2, SP:<0.1, SK:<-0.2, BP:>-0.1
- BK:>0.5, SP:<0.4, SK:<-0.5, BP:>-0.4
- BK:>0.8, SP:<0.7, SK:<-0.8, BP:>-0.7
##### 1.1.3 开仓阈值 < 平仓阈值 (3组)
- BK:>0.2, SP:<0.3, SK:<-0.2, BP:>-0.3
- BK:>0.5, SP:<0.6, SK:<-0.5, BP:>-0.6
- BK:>0.8, SP:<0.9, SK:<-0.8, BP:>-0.9

#### 1.2 二类型(9组)
BK:>正 SP:>正, SK:<负, BP:<负
##### 1.2.1 开仓阈值 + 0.1 = 平仓阈值 (3组)
- BK:>0.2, SP:>0.3, SK:<-0.2, BP:<-0.3
- BK:>0.4, SP:>0.5, SK:<-0.4, BP:<-0.5
- BK:>0.6, SP:>0.7, SK:<-0.6, BP:<-0.7
##### 1.2.2 开仓阈值 + 0.2 = 平仓阈值 (3组)
- BK:>0.2, SP:>0.4, SK:<-0.2, BP:<-0.4
- BK:>0.4, SP:>0.6, SK:<-0.4, BP:<-0.6
- BK:>0.6, SP:>0.8, SK:<-0.6, BP:<-0.8
##### 1.2.3 开仓阈值 + 0.3 = 平仓阈值 (3组)
- BK:>0.2, SP:>0.5, SK:<-0.2, BP:<-0.5
- BK:>0.4, SP:>0.7, SK:<-0.4, BP:<-0.7
- BK:>0.6, SP:>0.9, SK:<-0.6, BP:<-0.9

#### 1.3 三类型(9组)
BK:<负 SP:>负, SK:>正, BP:<正
##### 1.3.1 开仓阈值 = 平仓阈值 (3组)
- BK:<-0.2, SP:>-0.2, SK:>0.2, BP:<0.2
- BK:<-0.5, SP:>-0.5, SK:>0.5, BP:<0.5
- BK:<-0.8, SP:>-0.8, SK:>0.8, BP:<0.8
##### 1.3.2 开仓阈值 > 平仓阈值 (3组)
- BK:<-0.2, SP:>-0.1, SK:>0.2, BP:<0.1
- BK:<-0.5, SP:>-0.4, SK:>0.5, BP:<0.4
- BK:<-0.8, SP:>-0.7, SK:>0.8, BP:<0.7
##### 1.3.3 开仓阈值 < 平仓阈值 (3组)
- BK:<-0.2, SP:>-0.3, SK:>0.2, BP:<0.3
- BK:<-0.5, SP:>-0.6, SK:>0.5, BP:<0.6
- BK:<-0.8, SP:>-0.9, SK:>0.8, BP:<0.9

#### 1.4 四类型(9组)
BK:<负 SP:<负, SK:>正, BP:>正
##### 1.4.1 开仓阈值 + 0.1 = 平仓阈值 (3组)
- BK:<-0.2, SP:<-0.3, SK:>0.2, BP:>0.3
- BK:<-0.4, SP:<-0.5, SK:>0.4, BP:>0.5
- BK:<-0.6, SP:<-0.7, SK:>0.6, BP:>0.7
##### 1.4.2 开仓阈值 + 0.2 = 平仓阈值 (3组)
- BK:<-0.2, SP:<-0.4, SK:>0.2, BP:>0.4
- BK:<-0.4, SP:<-0.6, SK:>0.4, BP:>0.6
- BK:<-0.6, SP:<-0.8, SK:>0.6, BP:>0.8
##### 1.4.3 开仓阈值 + 0.3 = 平仓阈值 (3组)
- BK:<-0.2, SP:<-0.5, SK:>0.2, BP:>0.5
- BK:<-0.4, SP:<-0.7, SK:>0.4, BP:>0.7
- BK:<-0.6, SP:<-0.9, SK:>0.6, BP:>0.9

### 2. 选取评价指标较优的参数(年化收益、最大回撤、夏普率、交易频率)

### 3. 局部最优参数遍历(阈值)
例如步骤2选择的其中一组参数是:  
`BK:>0.5, SP:<0.4, SK:<-0.5, BP:>-0.4, stop_profit:0.03, stop_loss:0.03`

1. 固定BK和SK, 寻找SP和BP的最优参数(范围0~0.5，步长0.05)。假设选到的是0.35，更新当前的最优参数是：`BK:>0.5, SP:<0.35, SK:<-0.5, BP:>-0.35, stop_profit:0.03, stop_loss:0.03`
2. 固定SP和BP，寻找BK和SK的最优参数(范围0.35~0.9，步长0.05)。假设选到的是0.60，更新当前的最优参数是：`BK:>0.60, SP:<0.35, SK:<-0.60, BP:>-0.35, stop_profit:0.03, stop_loss:0.03`
3. 循环步骤1和2。如果经过一轮循环后，参数没有更新，就结束遍历，认为当前参数是最佳阈值。

### 4. 局部最优参数遍历(止盈止损)
例如步骤3得到的参数是：
`BK:>0.60, SP:<0.35, SK:<-0.60, BP:>-0.35, stop_profit:0.03, stop_loss:0.03`

1. 固定止盈，遍历止损(范围0.01到~0.05, 步长0.005);
2. 固定止损，遍历止盈(范围0.01到~0.05, 步长0.005);
3. 循环步骤1和2。如果经过一轮循环后，参数没有更新，就结束遍历，认为当前参数是最佳止盈止损。

### 5. 循环步骤3和步骤4。直到参数没有更新。
### 6. 参数局部稳定性验证
1) 用随机数，生成一组随机小幅扰动，其中阈值扰动范围`-0.05~0.05`, 止盈止损扰动范围`-0.005~0.005`。例如随机扰动是:  
`threshold1=0.03, threshold2=-0.02, stop_profit=0.004, stop_loss=-0.003`  
2) 然后用步骤5得到的参数，叠加上扰动，例如：  
`BK:>(0.60+0.03), SP:<(0.35-0.02), SK:<-(0.60+0.03), BP:>-(0.35-0.02), stop_profit:(0.03+0.004), stop_loss:(0.03-0.003)`  
3) 用扰动后的参数回测，验证几个评价指标没有突变。  
4) 重复步骤1到步骤3，多次验证。  

